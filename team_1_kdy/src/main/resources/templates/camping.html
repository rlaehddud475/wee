<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캠핑장 예약 시스템</title>
    <style>
        .disabled { color: grey; }
    </style>
</head>
<body>
    <h1>캠핑장 예약 시스템</h1>
    <form id="reservation-form">
        <label for="date">날짜:</label>
        <input type="date" id="date" name="date" required>
        <br><br>
        <label for="spot">캠핑장 자리:</label>
        <select id="spot" name="spot" required>
            <option value="">자리 선택</option>
            <!-- 자리는 자바스크립트로 동적으로 추가됩니다 -->
        </select>
        <br><br>
        <button type="submit">예약하기</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const spotSelect = document.getElementById('spot');
            const dateInput = document.getElementById('date');
            
            // 초기 자리 로딩
            loadSpots();

            // 날짜 변경 시 가능한 자리를 새로 고침
            dateInput.addEventListener('change', function() {
                loadSpots();
            });

            // 예약 폼 제출
            document.getElementById('reservation-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const date = dateInput.value;
                const spot = spotSelect.value;

                if (!date || !spot) {
                    alert('날짜와 자리를 모두 선택해 주세요.');
                    return;
                }

                // 서버에 예약 요청 전송
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/camping', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        alert('예약이 완료되었습니다.');
                        loadSpots(); // 예약 후 가능한 자리 업데이트
                    }
                };
                xhr.send(JSON.stringify({ date: date, spot: spot }));
            });

            // 자리 로딩 함수
            function loadSpots() {
                const date = dateInput.value;
                if (!date) return;

                // 서버에서 가능한 자리를 요청
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `/available-spots?date=${encodeURIComponent(date)}`, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        const availableSpots = JSON.parse(xhr.responseText);
                        updateSpotSelect(availableSpots);
                    }
                };
                xhr.send();
            }

            // 자리 선택박스 업데이트 함수
            function updateSpotSelect(availableSpots) {
                while (spotSelect.firstChild) {
                    spotSelect.removeChild(spotSelect.firstChild);
                }

                const defaultOption = document.createElement('option');
                defaultOption.textContent = '자리 선택';
                defaultOption.value = '';
                spotSelect.appendChild(defaultOption);

                for (const spot of availableSpots) {
                    const option = document.createElement('option');
                    option.value = spot;
                    option.textContent = spot;
                    spotSelect.appendChild(option);
                }
            }
        });
    </script>
</body>
</html>